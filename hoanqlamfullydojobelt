-- Dojo Belt UI + Fragments + Dragon Mats + Rainbow Haki + Race
-- FPS Boost + Ping/FPS + UI elements

--------------------------------------------------
-- CONFIG OVERRIDE RAINBOW
--------------------------------------------------
getgenv().RainbowOwned = true              -- ép luôn CÓ Rainbow Haki
getgenv().RainbowName  = "Rainbow Saviour" -- tên hiển thị

--------------------------------------------------
-- SERVICES
--------------------------------------------------
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local Stats             = game:GetService("Stats")
local Lighting          = game:GetService("Lighting")
local Terrain           = workspace:FindFirstChildOfClass("Terrain")
local LP                = Players.LocalPlayer
local CommF_            = ReplicatedStorage:WaitForChild("Remotes"):FindFirstChild("CommF_")

-- character ref để FPS boost không xoá người
local Character = LP.Character or LP.CharacterAdded:Wait()
LP.CharacterAdded:Connect(function(c)
    Character = c
end)

--------------------------------------------------
-- FPS BOOST (MAX TIẾT KIỆM ĐỒ HỌA + SUPER EXTREME CLEAN)
--------------------------------------------------

-- NPC / Player check
local function isCharacterOrNPC(obj)
    local mdl = obj:FindFirstAncestorOfClass("Model")
    if not mdl then return false end
    if mdl == Character then return true end
    if mdl:FindFirstChildOfClass("Humanoid") then
        return true
    end
    return false
end

-- Hàm xoá cực mạnh, giữ NPC + player, giữ vài sàn siêu to
local function superNuke(obj)
    if isCharacterOrNPC(obj) then return end

    if obj:IsA("Decal")
    or obj:IsA("Texture")
    or obj:IsA("ParticleEmitter")
    or obj:IsA("Smoke")
    or obj:IsA("Fire")
    or obj:IsA("Sparkles")
    or obj:IsA("Trail")
    or obj:IsA("Beam")
    or obj:IsA("Highlight")
    or obj:IsA("Explosion") then
        obj:Destroy()
        return
    end

    if obj:IsA("SpecialMesh") then
        obj:Destroy()
        return
    end

    if obj:IsA("BasePart") then
        local size    = obj.Size
        local maxAxis = math.max(size.X, size.Y, size.Z)
        local minAxis = math.min(size.X, size.Y, size.Z)

        -- Giữ lại sàn / tường siêu to & mỏng để khỏi rơi map
        local isHugeFloor = (maxAxis >= 120 and minAxis <= 8 and obj.Anchored)

        if not isHugeFloor then
            if maxAxis <= 300 then
                obj:Destroy()
                return
            end
        end

        -- Những part còn lại (rất to) thì đơn giản hoá hết
        obj.Material = Enum.Material.SmoothPlastic
        obj.Reflectance = 0
        obj.CastShadow = false
        obj.BackSurface   = Enum.SurfaceType.Smooth
        obj.BottomSurface = Enum.SurfaceType.Smooth
        obj.TopSurface    = Enum.SurfaceType.Smooth
        obj.FrontSurface  = Enum.SurfaceType.Smooth
        obj.LeftSurface   = Enum.SurfaceType.Smooth
        obj.RightSurface  = Enum.SurfaceType.Smooth

        if obj:IsA("MeshPart") then
            obj.MeshId = ""
            obj.TextureID = ""
        end
    end
end

local function fullClean()
    for _, v in ipairs(workspace:GetDescendants()) do
        pcall(function()
            superNuke(v)
        end)
    end
end

local function fpsBoost()
    -- Hạ quality thấp nhất
    pcall(function()
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    end)

    -- Lighting siêu đơn giản
    pcall(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = 1
        Lighting.ClockTime = 14
        Lighting.EnvironmentSpecularScale = 0
        Lighting.EnvironmentDiffuseScale  = 0
        Lighting.Ambient = Color3.new(0.5,0.5,0.5)
        if Lighting.Technology ~= Enum.Technology.Compatibility then
            Lighting.Technology = Enum.Technology.Compatibility
        end
    end)

    -- Tắt post-processing effect
    pcall(function()
        for _, v in ipairs(Lighting:GetDescendants()) do
            if v:IsA("BlurEffect")
            or v:IsA("SunRaysEffect")
            or v:IsA("ColorCorrectionEffect")
            or v:IsA("BloomEffect")
            or v:IsA("DepthOfFieldEffect") then
                v.Enabled = false
            end
        end
    end)

    -- Terrain siêu nhẹ
    pcall(function()
        if Terrain then
            Terrain.WaterWaveSize   = 0
            Terrain.WaterWaveSpeed  = 0
            Terrain.WaterReflectance= 0
            Terrain.WaterTransparency = 0
        end
    end)

    -- Xoá folder Effects nếu game có
    pcall(function()
        local effNames = {"Effects","Effect","VFX","FX"}
        for _, n in ipairs(effNames) do
            local f = workspace:FindFirstChild(n)
            if f then f:Destroy() end
        end
    end)

    -- Tắt Face & phụ kiện shine (nhẹ thêm)
    pcall(function()
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr.Character then
                for _, d in ipairs(plr.Character:GetDescendants()) do
                    if d:IsA("Accessory") then
                        local h = d:FindFirstChildWhichIsA("MeshPart")
                                or d:FindFirstChildWhichIsA("Part")
                        if h then
                            h.CastShadow = false
                            h.Material = Enum.Material.SmoothPlastic
                        end
                    elseif d:IsA("Decal") and d.Name == "face" then
                        d.Transparency = 1
                    end
                end
            end
        end
    end)

    -- Giới hạn FPS (sửa số nếu muốn cao hơn)
    pcall(function()
        if setfpscap then
            setfpscap(60)
        end
    end)

    -- Lần dọn đầu tiên
    fullClean()

    -- Dọn cho object spawn mới
    workspace.DescendantAdded:Connect(function(obj)
        task.defer(function()
            pcall(superNuke, obj)
        end)
    end)

    -- Lặp lại 5s dọn 1 lần
    task.spawn(function()
        while true do
            fullClean()
            task.wait(5)
        end
    end)
end

fpsBoost()

--------------------------------------------------
-- BELT DATA
--------------------------------------------------
local PRIORITY = {
    White = 1, Yellow = 2, Orange = 3, Green = 4,
    Blue  = 5, Purple = 6, Red    = 7, Black  = 8,
}

local ORDER = { "White","Yellow","Orange","Green","Blue","Purple","Red","Black" }
local TOTAL_BELTS = #ORDER

local COLORS = {
    White  = Color3.fromRGB(255,255,255),
    Yellow = Color3.fromRGB(255,230,0),
    Orange = Color3.fromRGB(255,140,0),
    Green  = Color3.fromRGB(0,255,0),
    Blue   = Color3.fromRGB(0,170,255),
    Purple = Color3.fromRGB(170,0,255),
    Red    = Color3.fromRGB(255,0,0),
    Black  = Color3.fromRGB(0,0,0),
}

local CANON = {
    white="White", yellow="Yellow", orange="Orange", green="Green",
    blue="Blue", purple="Purple", red="Red", black="Black",
}

local function colorToRich(c)
    return string.format("rgb(%d,%d,%d)", c.R*255, c.G*255, c.B*255)
end

local function titleCase(s)
    s = string.lower(s)
    return CANON[s] or (string.sub(s,1,1):upper() .. string.sub(s,2))
end

--------------------------------------------------
-- INVENTORY HELPER
--------------------------------------------------
local function getInventory()
    if not CommF_ then return nil end
    local methods = {"getInventory","GetInventory","getInventory2","GetItems"}

    for _, m in ipairs(methods) do
        local ok, inv = pcall(function()
            return CommF_:InvokeServer(m)
        end)
        if ok and type(inv) == "table" then
            return inv
        end
    end
end

--------------------------------------------------
-- BELT PARSE
--------------------------------------------------
local function parseVariant(name)
    name = tostring(name or "")
    local v = name:match("%[(.-)%]") or name:match("%((.-)%)")

    if not v then
        local tail = name:gsub("dojo%s*belt","",1):gsub("%p"," "):gsub("%s+"," ")
        local last = tail:match("(%w+)$")
        if last and CANON[last:lower()] then v = last end
    end

    if not v then return nil end
    return titleCase(v)
end

local function getHighestBelt()
    local inv = getInventory()
    if not inv then return nil end
    local best, bestScore = nil, -1

    for _, item in ipairs(inv) do
        local name = tostring(item.Name or item.name or "")
        if name:lower():find("dojo belt") then
            local var = parseVariant(name)
            local p = var and PRIORITY[var]
            if p and p > bestScore then
                best = var
                bestScore = p
            end
        end
    end

    return best
end

local function getNextVariant(variant)
    local idx = PRIORITY[variant]
    if not idx then return nil end
    return ORDER[idx + 1]
end

--------------------------------------------------
-- FRAGMENTS
--------------------------------------------------
local function getFragments()
    local data = LP:FindFirstChild("Data")
    if not data then return 0 end

    local frag = data.Fragments or data.Fragment or data.Frags
    return frag and frag.Value or 0
end

local function fmt(n)
    local s = tostring(n)
    while true do
        local new, k = s:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
        s = new
        if k == 0 then break end
    end
    return s
end

--------------------------------------------------
-- DRAGON MATS
--------------------------------------------------
local function countItem(exact)
    local inv = getInventory()
    if not inv then return 0 end
    local total = 0

    for _, item in ipairs(inv) do
        local name = tostring(item.Name or item.name or "")
        if name == exact then
            total = total + (item.Count or item.count or 1)
        end
    end

    return total
end

function getDragonMats()
    return {
        DragonScale   = countItem("Dragon Scale"),
        BlazeEmber    = countItem("Blaze Ember"),
        DinosaurBones = countItem("Dinosaur Bones"),
        DragonEgg     = countItem("Dragon Egg")
    }
end

--------------------------------------------------
-- RACE CHECK
--------------------------------------------------
local KNOWN_RACES = {
    "Human","Shark","Mink","Angel","Ghoul","Cyborg",
    "Fishman","Skypian","Rabbit","Dragon","Leopard","Draco"
}

local function getRaceInfo()
    local data = LP:FindFirstChild("Data")
    if not data then return "None","V0" end

    local raceName = "None"
    local raceVal = data:FindFirstChild("Race")
    if raceVal then
        raceName = tostring(raceVal.Value)
    else
        for _, v in ipairs(data:GetDescendants()) do
            if v:IsA("StringValue") then
                local val = v.Value:lower()
                for _, r in ipairs(KNOWN_RACES) do
                    if val:find(r:lower()) then
                        raceName = v.Value
                    end
                end
            end
        end
    end

    local stage = 0
    local aw = data:FindFirstChild("RaceAwakened")
    if aw then
        stage = tonumber(aw.Value) or 0
    end

    local T = { [0]="V1",[1]="V2",[2]="V3",[3]="V4" }
    return raceName, T[stage] or "V1"
end

--------------------------------------------------
-- RAINBOW HAKI
--------------------------------------------------
local function hasRainbowHaki()
    if getgenv().RainbowOwned ~= nil then
        return getgenv().RainbowOwned, getgenv().RainbowName or "Rainbow Saviour"
    end
    return false, "NOT OWNED"
end

--------------------------------------------------
-- PING + FPS
--------------------------------------------------
local currentFPS = 0

RunService.RenderStepped:Connect(function(dt)
    local fps = math.floor(1 / math.max(dt, 1/1000))
    if fps > 0 and fps < 1000 then
        currentFPS = fps
    end
end)

local function getPing()
    local ok, ping = pcall(function()
        local net = Stats.Network
        local item = net.ServerStatsItem["Data Ping"]
        return math.floor(item:GetValue())
    end)
    if ok then return ping end
    return 0
end

--------------------------------------------------
-- UI SETUP
--------------------------------------------------
local gui = Instance.new("ScreenGui")
gui.Name = "DojoTopUI"
gui.Parent = game.CoreGui

local function newLabel(y)
    local L = Instance.new("TextLabel", gui)
    L.AnchorPoint = Vector2.new(0.5,0)
    L.Position    = UDim2.new(0.5,0,y,0)
    L.Size        = UDim2.new(0,600,0,26)
    L.BackgroundTransparency = 1
    L.Font = Enum.Font.GothamBlack
    L.TextScaled = true
    L.RichText = true
    L.TextColor3 = Color3.fromRGB(255,255,255)

    local S = Instance.new("UIStroke", L)
    S.Thickness = 3
    S.Color = Color3.fromRGB(0,0,0)

    return L
end

-- Dòng Ping/FPS (trên Belt)
local sysLabel    = newLabel(0.08)
-- Belt
local topLabel    = newLabel(0.12)
-- Fragments (hồng tím)
local fragLabel   = newLabel(0.17)
-- Dragon Mats
local matsLabel   = newLabel(0.21)
-- Rainbow Haki
local hakiLabel   = newLabel(0.25)
-- Race
local raceLabel   = newLabel(0.29)
-- Status line
local statusLabel = newLabel(0.33)

fragLabel.TextColor3 = Color3.fromRGB(255,0,255)

--------------------------------------------------
-- UPDATE UI
--------------------------------------------------
local function updateUI()
    -- SYS: Ping / FPS với màu động
    local ping = getPing()
    local pingColor
    if ping <= 80 then
        pingColor = "rgb(0,255,0)"
    elseif ping <= 200 then
        pingColor = "rgb(255,255,0)"
    else
        pingColor = "rgb(255,0,0)"
    end

    sysLabel.Text = string.format(
        'Ping: <font color="%s">%d ms</font> | FPS: <font color="rgb(255,255,255)">%d</font>',
        pingColor, ping, currentFPS
    )

    -- BELT
    local curr = getHighestBelt()
    if curr then
        local idx  = PRIORITY[curr]
        local nextV = getNextVariant(curr)
        local cColor = (curr == "Black") and "rgb(220,0,0)" or colorToRich(COLORS[curr])

        if nextV then
            topLabel.Text = string.format(
                'Current: <font color="%s">%s</font> (%d/8) | Next: <font color="%s">%s</font>',
                cColor, curr, idx, colorToRich(COLORS[nextV]), nextV
            )
        else
            topLabel.Text = string.format(
                'Current: <font color="%s">%s</font> (%d/8) | <font color="rgb(255,0,0)">MAX</font>',
                cColor, curr, idx
            )
        end
    else
        topLabel.Text = 'Current: None (0/8) | Next: White'
    end

    -- FRAGMENTS
    fragLabel.Text = "Fragments: " .. fmt(getFragments())

    -- DRAGON MATERIALS
    local M = getDragonMats()
    matsLabel.Text = string.format(
        'Scale: <font color="rgb(170,0,255)">%d</font> | Ember: <font color="rgb(255,140,0)">%d</font> | Bones: <font color="rgb(0,255,0)">%d</font> | Egg: <font color="rgb(0,170,255)">%d</font>',
        M.DragonScale, M.BlazeEmber, M.DinosaurBones, M.DragonEgg
    )

    -- HAKI RAINBOW
    local own, aura = hasRainbowHaki()
    if own then
        hakiLabel.Text = string.format(
            '<font color="rgb(0,255,0)">Rainbow Haki: %s ✓</font>',
            aura
        )
    else
        hakiLabel.Text = '<font color="rgb(255,80,80)">Rainbow Haki: NOT OWNED</font>'
    end

    -- RACE
    local raceName, tier = getRaceInfo()
    raceLabel.Text = string.format(
        'Race: <font color="rgb(255,255,0)">%s</font> (<font color="rgb(0,255,0)">%s</font>)',
        raceName, tier
    )

    -- STATUS
    statusLabel.Text = '<font color="rgb(255,255,255)">Fully Draco is running… | HoanqLam</font>'
end

--------------------------------------------------
-- AUTO UPDATE LOOP
--------------------------------------------------
task.spawn(function()
    while gui.Parent do
        pcall(updateUI)
        task.wait(5)
    end
end)
